{
	"version": "2.0.0",
	"tasks": [
		{
			"label": "Gen clangd db",
			"type": "shell",
			"command": "scripts/clang-tools/gen_compile_commands.py",
			"options": {
				"cwd": "${workspaceFolder}/linux",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}"
				}
			},
			"detail": "compile commands 生成"
		},
		{
			"label": "Copy clangd db",
			"type": "shell",
			"command": "mv linux/compile_commands.json .vscode/build",
			"dependsOn": [
				"Gen clangd db"
			],
			"dependsOrder": "sequence",
			"options": {
				"cwd": "${workspaceFolder}",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}"
				}
			},
			"detail": "compile commands 生成",
			"problemMatcher": []
		},
		{
			"label": "Disasm ELF",
			"type": "shell",
			"command": "riscv64-linux-gnu-objdump -dx linux/vmlinux > vmlinux.disasm",
			"options": {
				"cwd": "${workspaceFolder}",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}",
					"ARCH": "riscv",
					"CROSS_COMPILE": "riscv64-linux-gnu-"
				}
			},
			"detail": "disasm"
		},
		{
			"label": "defconfig",
			"type": "shell",
			"command": "make defconfig",
			"options": {
				"cwd": "${workspaceFolder}/linux",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}",
					"ARCH": "riscv",
					"CROSS_COMPILE": "riscv64-linux-gnu-"
				}
			},
			"detail": "make defconfig"
		},
		{
			"label": "menuconfig",
			"type": "shell",
			"command": "make menuconfig",
			"options": {
				"cwd": "${workspaceFolder}/linux",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}",
					"ARCH": "riscv",
					"CROSS_COMPILE": "riscv64-linux-gnu-"
				}
			},
			"detail": "make menuconfig"
		},
		{
			"label": "gen rootfs",
			"type": "shell",
			"command": "find . | cpio -o --format=newc | gzip > ../rootfs.cpio.gz",
			"options": {
				"cwd": "${workspaceFolder}/rootfs",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}",
					"ARCH": "riscv",
					"CROSS_COMPILE": "riscv64-linux-gnu-"
				}
			}
		},
		{
			"label": "Compile RISC-V Linux Kernel",
			"type": "shell",
			"command": "make -j$(nproc)",
			"options": {
				"cwd": "${workspaceFolder}/linux",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}",
					"ARCH": "riscv",
					"CROSS_COMPILE": "riscv64-linux-gnu-"
				}
			},
			"dependsOn": [
				"menuconfig",
				"gen rootfs"
			],
			"dependsOrder": "sequence",
			"detail": "编译 RISCV 内核"
		},
		{
			"label": "qemu boot",
			"type": "shell",
			"options": {
				"cwd": "${workspaceFolder}",
				"env": {
					"PATH": "${env:HOME}/Code/python3.12/bin:${env:PATH}"
				}
			},
			"command": "qemu-system-riscv64",
			"args": [
				"-machine",
				"virt",
				"-nographic",
				"-smp",
				"1",
				"-m",
				"256M",
				"-kernel",
				"linux/arch/riscv/boot/Image",
				"-initrd",
				"rootfs.cpio.gz",
				"-append",
				"\"console=ttyS0 root=/dev/ram rw\""
			],
			"detail": "配置 qemu boot",
			"problemMatcher": [
				"$nvcc"
			]
		},
		{
			"label": "qemu boot debug",
			"type": "shell",
			"options": {
				"cwd": "${workspaceFolder}"
			},
			"command": "qemu-system-riscv64",
			"args": [
				"-machine",
				"virt",
				"-nographic",
				"-smp",
				"1",
				"-m",
				"256M",
				"-kernel",
				"linux/arch/riscv/boot/Image",
				"-initrd",
				"rootfs.cpio.gz",
				"-append",
				"\"console=ttyS0 root=/dev/ram rw\"",
				"-s",
				"-S"
			],
			"detail": "配置 qemu boot debug"
		},
		{
			"label": "git repo update",
			"detail": "git repo update",
			"command": "git submodule foreach --recursive git pull --rebase",
			"type": "shell",
			"options": {
				"cwd": "${workspaceFolder}"
			},
		}
	]
}
